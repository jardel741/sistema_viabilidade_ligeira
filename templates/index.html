<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Consulta de Viabilidade Ligeira Telecom</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.gridlayer.googlemutant@0.12.1/Leaflet.GoogleMutant.js"></script>
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA_9lJtzaBhEuCNSx9fKicTDsslVgv5_QM&libraries=places"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #map { height: 400px; margin-top: 20px; width: 100%; }
    input, button, select { padding: 8px; margin-top: 10px; width: 100%; }
    #relatorio { margin-top: 40px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
    a.download-link { display: inline-block; margin-top: 10px; color: blue; text-decoration: underline; cursor: pointer; }
  </style>
</head>
<body>
  <div id="debug" style="background: #eee; padding: 10px; font-family: monospace; margin-bottom: 20px;"></div>

  <img src="https://i.imgur.com/LcNQHQ4.png" alt="Logo Ligeira Telecom" style="max-width: 250px; display: block; margin-bottom: 10px;" />
  <h2>Consulta de Viabilidade Ligeira Telecom</h2>
  <input type="text" id="bairro" placeholder="Digite o bairro" />
  <input type="text" id="cidade" placeholder="Digite a cidade" />
  <input type="text" id="endereco" placeholder="Digite o endere√ßo ou coordenadas" />
  <input type="text" id="coordenadas" placeholder="Cole aqui a localiza√ß√£o compartilhada (latitude, longitude)" />
  <button onclick="usarMinhaLocalizacao()">üìç Usar minha localiza√ß√£o atual</button>
  <button onclick="consultarViabilidade()">Consultar</button>
  <div id="resultado"></div>
  <div id="map"></div>

  <div id="relatorio">
    <h3>Relat√≥rio de Consultas</h3>
    <button onclick="gerarRelatorio()">Gerar Relat√≥rio</button>
    <a id="downloadCsv" class="download-link" style="display: none">Baixar CSV</a>
    <div id="tabela-relatorio"></div>
  </div>

  <script>
    const historicoConsultas = [];

    const map = L.map("map").setView([-7.2, -39.3], 13);

    try {
      L.gridLayer.googleMutant({ maxZoom: 24, type: "satellite" }).addTo(map);
      console.log("‚úÖ Google Sat√©lite carregado");
    } catch (e1) {
      console.warn("‚ö†Ô∏è Sat√©lite falhou, tentando roadmap...");
      try {
        L.gridLayer.googleMutant({ maxZoom: 24, type: "roadmap" }).addTo(map);
        console.log("‚úÖ Google Roadmap carregado como fallback");
      } catch (e2) {
        console.warn("‚ùå Google falhou. Usando OpenStreetMap");
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "&copy; OpenStreetMap contributors"
        }).addTo(map);
      }
    }

    let geojsonCobertura;
    const debug = document.getElementById("debug");

    fetch("geojson")
      .then(res => {
        if (!res.ok) {
          debug.innerHTML = "‚ùå Erro ao carregar GeoJSON: " + res.status;
          throw new Error("Erro HTTP: " + res.status);
        }
        return res.json();
      })
      .then(data => {
        debug.innerHTML = `‚úÖ GeoJSON carregado com sucesso! Total de pol√≠gonos: ${data.features.length}`;
        geojsonCobertura = data;
        const layer = L.geoJSON(geojsonCobertura, {
          style: { color: "blue", weight: 2, fillOpacity: 0.1 },
          onEachFeature: function (feature, layer) {
            layer.on({
              mouseover: e => e.target.setStyle({ weight: 3, color: "#ff7800", fillOpacity: 0.3 }),
              mouseout: e => layer.resetStyle(e.target)
            });
          }
        }).addTo(map);
        map.fitBounds(layer.getBounds());
      })
      .catch(err => {
        debug.innerHTML += "<br>üõ†Ô∏è Detalhes t√©cnicos: " + err;
        console.error(err);
      });

    function consultarViabilidade() {
      const bairro = document.getElementById("bairro").value.trim();
      const cidade = document.getElementById("cidade").value.trim();
      const endereco = document.getElementById("endereco").value.trim();
      const coordenadas = document.getElementById("coordenadas").value.trim();
      const resultadoDiv = document.getElementById("resultado");

      if (!bairro || !cidade || !endereco) {
        resultadoDiv.innerHTML = '<p style="color: orange;">Preencha todos os campos.</p>';
        return;
      }

      let lat = null, lon = null, enderecoLat = null, enderecoLon = null, divergente = false;
      const enderecoCompleto = `${endereco}, ${bairro}, ${cidade}`;
      const geocodeUrl = `/geocode?address=${encodeURIComponent(enderecoCompleto)}`;

      fetch(geocodeUrl)
        .then(res => res.json())
        .then(data => {
          if (!data.results || data.results.length === 0) {
            resultadoDiv.innerHTML = '<p style="color: orange;">Endere√ßo n√£o encontrado.</p>';
            return;
          }

          enderecoLat = data.results[0].geometry.location.lat;
          enderecoLon = data.results[0].geometry.location.lng;

          if (coordenadas && /^-?\d+(\.\d+)?[ ,]+-?\d+(\.\d+)?$/.test(coordenadas)) {
            const parts = coordenadas.split(/[ ,]+/).map(Number);
            lat = parts[0];
            lon = parts[1];
            const distancia = turf.distance(
              turf.point([lon, lat]),
              turf.point([enderecoLon, enderecoLat]),
              { units: "kilometers" }
            );
            if (distancia > 0.3) divergente = true;
          } else {
            lat = enderecoLat;
            lon = enderecoLon;
          }

          const ponto = turf.point([lon, lat]);
          const viavel = geojsonCobertura.features.some(f => turf.booleanPointInPolygon(ponto, f));

          map.setView([lat, lon], 15);
          L.marker([lat, lon]).addTo(map);

          let resultadoTexto = "";
          if (divergente)
            resultadoTexto += '<p style="color: red;">A localiza√ß√£o n√£o est√° de acordo com o endere√ßo, favor corrigir a informa√ß√£o.</p>';
          resultadoTexto += viavel
            ? '<p style="color: green;">Cobertura dispon√≠vel nesse local.</p>'
            : '<p style="color: red;">Sem cobertura nesse local.</p>';

          resultadoDiv.innerHTML = resultadoTexto;

          historicoConsultas.push({ bairro, cidade, endereco, lat, lon, viavel, divergente });
        })
        .catch(err => {
          resultadoDiv.innerHTML = '<p style="color: orange;">Erro ao consultar a API do Google Maps.</p>';
          console.error(err);
        });
    }

    function gerarRelatorio() {
      const agregados = {};
      historicoConsultas.forEach(c => {
        const chave = `${c.cidade} - ${c.bairro} - ${c.endereco}`;
        if (!agregados[chave]) agregados[chave] = { count: 0, divergentes: 0 };
        agregados[chave].count++;
        if (c.divergente) agregados[chave].divergentes++;
      });

      let csv = "Cidade,Bairro,Endereco,Total,Com Diverg√™ncia\n";
      let html = "<table><thead><tr><th>Cidade</th><th>Bairro</th><th>Endere√ßo</th><th>Total</th><th>Com Diverg√™ncia</th></tr></thead><tbody>";
      for (const chave in agregados) {
        const [cidade, bairro, endereco] = chave.split(" - ");
        const { count, divergentes } = agregados[chave];
        html += `<tr><td>${cidade}</td><td>${bairro}</td><td>${endereco}</td><td>${count}</td><td>${divergentes}</td></tr>`;
        csv += `"${cidade}","${bairro}","${endereco}",${count},${divergentes}\n`;
      }
      html += "</tbody></table>";

      document.getElementById("tabela-relatorio").innerHTML = html;

      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const link = document.getElementById("downloadCsv");
      link.href = url;
      link.download = "relatorio_viabilidade.csv";
      link.style.display = "inline-block";
    }

    const autocomplete = new google.maps.places.Autocomplete(
      document.getElementById("endereco"),
      {
        types: ["geocode"],
        componentRestrictions: { country: "br" },
      }
    );

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        function (position) {
          const userLat = position.coords.latitude;
          const userLng = position.coords.longitude;
          map.setView([userLat, userLng], 15);
          L.marker([userLat, userLng]).addTo(map).bindPopup("üìç Voc√™ est√° aqui").openPopup();
          debug.innerHTML += `<br>üìç Localiza√ß√£o detectada: ${userLat.toFixed(5)}, ${userLng.toFixed(5)}`;
        },
        function () {
          debug.innerHTML += "<br>‚ö†Ô∏è N√£o foi poss√≠vel obter sua localiza√ß√£o.";
        }
      );
    }

    function usarMinhaLocalizacao() {
      if (!navigator.geolocation) {
        alert("Geolocaliza√ß√£o n√£o suportada neste navegador.");
        return;
      }
      navigator.geolocation.getCurrentPosition(
        function (position) {
          const lat = position.coords.latitude.toFixed(6);
          const lng = position.coords.longitude.toFixed(6);
          const coordenadas = `${lat}, ${lng}`;
          document.getElementById("coordenadas").value = coordenadas;
          map.setView([lat, lng], 15);
          L.marker([lat, lng]).addTo(map).bindPopup("üìç Sua localiza√ß√£o atual").openPopup();
          debug.innerHTML += `<br>üìå Coordenadas inseridas: ${coordenadas}`;
        },
        function (error) {
          alert("Erro ao obter localiza√ß√£o: " + error.message);
        }
      );
    }
  </script>

  <footer style="text-align: center; margin-top: 40px; font-size: 0.9em; color: #666">
    &copy; 2025 Designed by Carlos Jardel e OpenAI
  </footer>
</body>
</html>
