<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Consulta de Viabilidade Ligeira Telecom</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.gridlayer.googlemutant@0.12.1/Leaflet.GoogleMutant.js"></script>
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
  <script src="/maps-api.js"></script>

  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      background-color: #FFC107;
      color: #333;
    }

    header {
      background: #6200EA;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      flex-wrap: wrap;
    }

    header img {
      max-height: 60px;
    }

    header .btn-verde {
      background: #00C853;
      border: none;
      padding: 10px 20px;
      color: white;
      font-weight: bold;
      border-radius: 30px;
      cursor: pointer;
    }

    h2 {
      text-align: center;
      margin: 30px 10px 10px;
      font-size: 2rem;
    }

    .container {
      padding: 20px;
      max-width: 900px;
      margin: auto;
    }

    input, button, select {
      padding: 10px;
      margin-top: 10px;
      width: 100%;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 1rem;
    }

    button {
      cursor: pointer;
      background-color: #6200EA;
      color: white;
      border: none;
      font-weight: bold;
    }

    #map {
      height: 400px;
      margin-top: 20px;
      width: 100%;
      border-radius: 8px;
      border: 2px solid #6200EA;
    }

    #resultado {
      margin-top: 20px;
      font-size: 1.1rem;
    }

    #relatorio {
      margin-top: 40px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }

    th {
      background-color: #eee;
    }

    .download-link {
      display: inline-block;
      margin-top: 10px;
      color: blue;
      text-decoration: underline;
      cursor: pointer;
    }

    footer {
      background: #6200EA;
      color: white;
      text-align: center;
      padding: 15px;
      margin-top: 50px;
    }
  </style>
</head>
<body>

  <header>
    <img src="https://i.imgur.com/LcNQHQ4.png" alt="Logo Ligeira Telecom" />
    <button class="btn-verde">Assine pelo WhatsApp</button>
  </header>

  <div class="container">
    <h2>Consulta de Viabilidade Ligeira Telecom</h2>

    <input type="text" id="bairro" placeholder="Digite o bairro" />
    <input type="text" id="cidade" placeholder="Digite a cidade" />
    <input type="text" id="endereco" placeholder="Digite o endere√ßo" />
    <input type="text" id="coordenadas" placeholder="Cole aqui a localiza√ß√£o (latitude, longitude)" />
    <button onclick="usarMinhaLocalizacao()">üìç Usar minha localiza√ß√£o atual</button>
    <div id="resultado"></div>
    <div id="map"></div>

    <div id="relatorio">
      <h3>Relat√≥rio de Viabilidades</h3>
      <button onclick="mostrarRelatorio()">üìä Ver relat√≥rio</button>
      <div id="tabelaRelatorio"></div>
      <div id="resumoRelatorio" style="margin-top: 10px; font-weight: bold;"></div>
    </div>
  </div>

  <script>
    const map = L.map("map").setView([-7.2, -39.3], 13);
    let marcadorEndereco = null;
    let marcadorCoordenada = null;
    let geojsonCobertura;
    const consultas = [];

    const iconeAmarelo = new L.Icon({
      iconUrl: "https://maps.google.com/mapfiles/ms/icons/yellow-dot.png",
      iconSize: [32, 32],
      iconAnchor: [16, 32],
      popupAnchor: [0, -32]
    });

    const iconeVerde = new L.Icon({
      iconUrl: "https://maps.google.com/mapfiles/ms/icons/green-dot.png",
      iconSize: [32, 32],
      iconAnchor: [16, 32],
      popupAnchor: [0, -32]
    });

    try {
      L.gridLayer.googleMutant({ maxZoom: 24, type: "satellite" }).addTo(map);
    } catch {
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
    }

    fetch("/geojson")
      .then(res => res.json())
      .then(data => {
        geojsonCobertura = data;
        const layer = L.geoJSON(data, {
          style: { color: "blue", weight: 2, fillOpacity: 0.1 }
        }).addTo(map);
        map.fitBounds(layer.getBounds());
      });

    function marcarEndereco() {
      const endereco = document.getElementById("endereco").value.trim();
      const bairro = document.getElementById("bairro").value.trim();
      const cidade = document.getElementById("cidade").value.trim();
      if (!endereco || !bairro || !cidade) return;

      const full = `${endereco}, ${bairro}, ${cidade}`;
      fetch(`/geocode?address=${encodeURIComponent(full)}`)
        .then(res => res.json())
        .then(data => {
          if (!data.results?.length) return;
          const loc = data.results[0].geometry.location;

          if (marcadorEndereco) map.removeLayer(marcadorEndereco);
          marcadorEndereco = L.marker([loc.lat, loc.lng], { icon: iconeAmarelo })
            .addTo(map).bindPopup("üìç Endere√ßo digitado").openPopup();

          map.setView([loc.lat, loc.lng], 15);
          document.getElementById("endereco").dataset.lat = loc.lat;
          document.getElementById("endereco").dataset.lng = loc.lng;

          diagnosticar(bairro, cidade, loc.lat, loc.lng);
        });
    }

    function diagnosticar(bairro, cidade, latEnd, lngEnd) {
      const coordText = document.getElementById("coordenadas").value.trim();
      const enderecoLat = parseFloat(document.getElementById("endereco").dataset.lat || latEnd);
      const enderecoLng = parseFloat(document.getElementById("endereco").dataset.lng || lngEnd);
      const resultadoDiv = document.getElementById("resultado");

      if (!coordText || isNaN(enderecoLat) || isNaN(enderecoLng)) return;

      const [lat, lng] = coordText.split(/[ ,]+/).map(Number);
      if (isNaN(lat) || isNaN(lng)) return;

      if (marcadorCoordenada) map.removeLayer(marcadorCoordenada);
      marcadorCoordenada = L.marker([lat, lng], { icon: iconeVerde })
        .addTo(map).bindPopup("üìç Coordenada fornecida").openPopup();

      map.setView([lat, lng], 15);

      const ponto = turf.point([lng, lat]);
      const viavel = geojsonCobertura.features.some(f => turf.booleanPointInPolygon(ponto, f));

      const distancia = turf.distance(
        turf.point([enderecoLng, enderecoLat]),
        turf.point([lng, lat]),
        { units: "kilometers" }
      );

      let resultado = "";
      if (distancia > 0.3) {
        resultado += `<p style="color: red;">A localiza√ß√£o n√£o est√° de acordo com o endere√ßo, favor corrigir a informa√ß√£o.</p>`;
      }
      resultado += viavel
        ? `<p style="color: green;">Cobertura dispon√≠vel nesse local.</p>`
        : `<p style="color: red;">Sem cobertura nesse local.</p>`;

      resultadoDiv.innerHTML = resultado;

      consultas.push({ bairro, cidade, lat, lng, viavel });
    }

    function mostrarRelatorio() {
      if (consultas.length === 0) {
        document.getElementById("tabelaRelatorio").innerHTML = "<p>Nenhuma consulta realizada.</p>";
        return;
      }

      const tabela = `
        <table>
          <thead><tr><th>Bairro</th><th>Cidade</th><th>Latitude</th><th>Longitude</th><th>Vi√°vel?</th></tr></thead>
          <tbody>
            ${consultas.map(c => `<tr><td>${c.bairro}</td><td>${c.cidade}</td><td>${c.lat}</td><td>${c.lng}</td><td>${c.viavel ? '‚úÖ' : '‚ùå'}</td></tr>`).join("")}
          </tbody>
        </table>
      `;
      document.getElementById("tabelaRelatorio").innerHTML = tabela;

      const agrupado = {};
      consultas.forEach(c => {
        const key = `${c.bairro} - ${c.cidade}`;
        if (!agrupado[key]) agrupado[key] = 0;
        if (c.viavel) agrupado[key]++;
      });

      const maior = Object.entries(agrupado).sort((a, b) => b[1] - a[1])[0];
      if (maior) {
        document.getElementById("resumoRelatorio").textContent =
          `üìç Maior n√∫mero de viabilidades: ${maior[0]} (${maior[1]} consultas vi√°veis)`;
      }
    }

    function usarMinhaLocalizacao() {
      if (!navigator.geolocation) return alert("Geolocaliza√ß√£o n√£o suportada.");
      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude.toFixed(6);
        const lng = pos.coords.longitude.toFixed(6);
        document.getElementById("coordenadas").value = `${lat}, ${lng}`;
        const bairro = document.getElementById("bairro").value.trim();
        const cidade = document.getElementById("cidade").value.trim();
        diagnosticar(bairro, cidade);
      }, err => alert("Erro ao obter localiza√ß√£o: " + err.message));
    }

    document.getElementById("endereco").addEventListener("blur", marcarEndereco);
    document.getElementById("coordenadas").addEventListener("input", () => {
      const bairro = document.getElementById("bairro").value.trim();
      const cidade = document.getElementById("cidade").value.trim();
      diagnosticar(bairro, cidade);
    });
  </script>

  <footer>
    &copy; 2025 Designed By Jardel e OpenAI - Todos os direitos reservados.
  </footer>

</body>
</html>
