<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Consulta de Viabilidade Ligeira Telecom</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.gridlayer.googlemutant@0.12.1/Leaflet.GoogleMutant.js"></script>
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
  <script src="/maps-api.js"></script>

  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #map { height: 400px; margin-top: 20px; width: 100%; }
    input, button, select { padding: 8px; margin-top: 10px; width: 100%; }
    #relatorio { margin-top: 40px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
    a.download-link { display: inline-block; margin-top: 10px; color: blue; text-decoration: underline; cursor: pointer; }
  </style>
</head>
<body>

  <img src="https://i.imgur.com/LcNQHQ4.png" alt="Logo Ligeira Telecom" style="max-width: 250px; display: block; margin-bottom: 10px;" />
  <h2>Consulta de Viabilidade Ligeira Telecom</h2>

  <input type="text" id="bairro" placeholder="Digite o bairro" />
  <input type="text" id="cidade" placeholder="Digite a cidade" />
  <input type="text" id="endereco" placeholder="Digite o endere√ßo" />
  <input type="text" id="coordenadas" placeholder="Cole aqui a localiza√ß√£o (latitude, longitude)" />
  <button onclick="usarMinhaLocalizacao()">üìç Usar minha localiza√ß√£o atual</button>
  <div id="resultado"></div>
  <div id="map"></div>

  <script>
    const map = L.map("map").setView([-7.2, -39.3], 13);
    let marcadorEndereco = null;
    let marcadorCoordenada = null;
    let geojsonCobertura;

    const iconeAmarelo = new L.Icon({
      iconUrl: "https://maps.google.com/mapfiles/ms/icons/yellow-dot.png",
      iconSize: [32, 32],
      iconAnchor: [16, 32],
      popupAnchor: [0, -32]
    });

    const iconeVerde = new L.Icon({
      iconUrl: "https://maps.google.com/mapfiles/ms/icons/green-dot.png",
      iconSize: [32, 32],
      iconAnchor: [16, 32],
      popupAnchor: [0, -32]
    });

    try {
      L.gridLayer.googleMutant({ maxZoom: 24, type: "satellite" }).addTo(map);
    } catch {
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
    }

    fetch("/geojson")
      .then(res => res.json())
      .then(data => {
        geojsonCobertura = data;
        const layer = L.geoJSON(data, {
          style: { color: "blue", weight: 2, fillOpacity: 0.1 }
        }).addTo(map);
        map.fitBounds(layer.getBounds());
      });

    function marcarEndereco() {
      const endereco = document.getElementById("endereco").value.trim();
      const bairro = document.getElementById("bairro").value.trim();
      const cidade = document.getElementById("cidade").value.trim();
      if (!endereco || !bairro || !cidade) return;

      const full = `${endereco}, ${bairro}, ${cidade}`;

      fetch(`/geocode?address=${encodeURIComponent(full)}`)
        .then(res => res.json())
        .then(data => {
          if (!data.results?.length) return;
          const loc = data.results[0].geometry.location;

          if (marcadorEndereco) map.removeLayer(marcadorEndereco);
          marcadorEndereco = L.marker([loc.lat, loc.lng], { icon: iconeAmarelo })
            .addTo(map).bindPopup("üìç Endere√ßo digitado").openPopup();

          map.setView([loc.lat, loc.lng], 15);
          document.getElementById("endereco").dataset.lat = loc.lat;
          document.getElementById("endereco").dataset.lng = loc.lng;

          diagnosticar();
        });
    }

    function diagnosticar() {
      const coordText = document.getElementById("coordenadas").value.trim();
      const enderecoLat = parseFloat(document.getElementById("endereco").dataset.lat || "NaN");
      const enderecoLng = parseFloat(document.getElementById("endereco").dataset.lng || "NaN");
      const resultadoDiv = document.getElementById("resultado");

      if (!coordText || isNaN(enderecoLat) || isNaN(enderecoLng)) return;

      const [lat, lng] = coordText.split(/[ ,]+/).map(Number);
      if (isNaN(lat) || isNaN(lng)) return;

      if (marcadorCoordenada) map.removeLayer(marcadorCoordenada);
      marcadorCoordenada = L.marker([lat, lng], { icon: iconeVerde })
        .addTo(map).bindPopup("üìç Coordenada fornecida").openPopup();

      map.setView([lat, lng], 15);

      const ponto = turf.point([lng, lat]);
      const viavel = geojsonCobertura.features.some(f => turf.booleanPointInPolygon(ponto, f));

      const distancia = turf.distance(
        turf.point([enderecoLng, enderecoLat]),
        turf.point([lng, lat]),
        { units: "kilometers" }
      );

      let resultado = "";
      if (distancia > 0.3) {
        resultado += `<p style="color: red;">A localiza√ß√£o n√£o est√° de acordo com o endere√ßo, favor corrigir a informa√ß√£o.</p>`;
      }
      resultado += viavel
        ? `<p style="color: green;">Cobertura dispon√≠vel nesse local.</p>`
        : `<p style="color: red;">Sem cobertura nesse local.</p>`;

      resultadoDiv.innerHTML = resultado;
    }

    function usarMinhaLocalizacao() {
      if (!navigator.geolocation) return alert("Geolocaliza√ß√£o n√£o suportada.");
      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude.toFixed(6);
        const lng = pos.coords.longitude.toFixed(6);
        document.getElementById("coordenadas").value = `${lat}, ${lng}`;
        diagnosticar();
      }, err => alert("Erro ao obter localiza√ß√£o: " + err.message));
    }

    // Eventos
    document.getElementById("endereco").addEventListener("blur", marcarEndereco);
    document.getElementById("coordenadas").addEventListener("input", diagnosticar);
  </script>

  <footer style="text-align: center; margin-top: 40px; font-size: 0.9em; color: #666">
    &copy; 2025 Designed by Carlos Jardel e OpenAI
  </footer>

</body>
</html>
